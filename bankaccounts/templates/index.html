<!doctype html>
<html lang="en">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

        <title>Banking System</title>
        <style>
            .accont-id{
                font-weight: 700;
                color: dodgerblue;
                font-size: 16px;
            }
            .balance{
                font-weight: bolder;
                color: green;
                
            }
            .balance::before{
                content: '$';
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="row">
                <div class="col-12 mt-4"  >
                    <div id="display" class="row row-cols-4 justify-content-start">
                    </div>
                </div>
                <div class="col-12 mt-4">
                    <div class="row justify-content-center">
                        <div id="myid" class='col-3 align-self-center accont-id'> 
                        </div>
                        <div id="mybalance" class='col-1 align-self-center balance'>
                            0 
                        </div>
                        <input id="account" placeholder="account_id" class="col-2 form-control"/>
                        <input id="amount" placeholder="amount" class="col-2 ml-1 form-control"/>
                        <select id="type" class="col-2 ml-1 form-control">
                            <option>Deposit</option>
                            <option>Withdraw</option>
                            <option>Transfer</option>
                        </select>
                        <button id="go" class="col-1 ml-1 btn btn-primary">Go</button>
                        
                    </div>
                </div>
            </div>
        </div>

        <!-- Optional JavaScript -->
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script type = "text/javascript" src = "https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
        <script>
            var my_id = null;
            function to_currency(amount){
                result = amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                return result
            }

            function new_account(id, balance){
                $("#display").append(
                    `<div id='${id}' class="card col ml-2 mt-2">\
                            <h5 id='${id}-title' class="card-title">${id}</h5>\
                            <div id='${id}-balance' class="balance">${to_currency(balance)}</div>\
                        </div>`
                )
            }

            function add_to_balance(id, balance){
                let balance_to_update = id == my_id? $("#mybalance") : $(`#${id}-balance`)
                let new_balance = balance_to_update.text();
                new_balance = new_balance.replace(" ", "")
                new_balance = new_balance.replace(",", "")
                new_balance = Number(new_balance) + balance
                balance_to_update.html(to_currency(new_balance))
            }

            $(document).ready(function() {
                $.get("http://localhost:8000/accounts", (data, status) => {
                    console.log("from jquery request");
                    console.log(data);
                    for(const account_id of Object.keys(data)){
                        new_account(account_id, Number(data[account_id]["balance"]))
                    }
                })
                var state = Math.random()
                let websocket = new WebSocket(`ws://localhost:8000/ws/${state}`);
                websocket.onmessage = function (event) {
                    console.log("from server")
                    let data = JSON.parse(event.data);
                    console.log(data);
                    let event_type = data.event_type;
                    console.log(event_type);
                    if(event_type == "new_account"){
                        new_account(data.account_id, 0);
                    }
                    else if(event_type == "account_transaction"){
                        add_to_balance(data.account_id, data.amount) 
                    }

                    else if(event_type == "account_error"){

                    }

                    else if(event_type == "connected"){
                        if(data.state == state){
                            my_id = data.account_id;
                            $("#myid").html(my_id);
                        }
                        
                    }
                }
                // do stuff when DOM is ready
                $( "#go" ).click(function() {
                    let account_id = $("#account").val()
                    let amount = $("#amount").val()
                    let type = $("#type").val()
                    let mybalance = $("#mybalance").html()
                    let send_data = {account_id, amount, type, mybalance}
                    if(type == "Deposit"){
                        send_data = {
                            type: "deposit",
                            credit_account_id: my_id,
                            amount: send_data.amount
                        }
                        websocket.send(JSON.stringify(send_data))
                    }
                    else if(type == "Withdraw"){
                        send_data = {
                            type: "withdraw",
                            debit_account_id: my_id,
                            amount: send_data.amount
                        }
                        websocket.send(JSON.stringify(send_data))
                    }
                    else if(type == "Transfer"){
                        send_data = {
                            type: "transfer",
                            debit_account_id: my_id,
                            credit_account_id: account_id,
                            amount: send_data.amount
                        }
                        websocket.send(JSON.stringify(send_data))
                    }
                });
            });
        </script>
    </body>
</html>